apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  name: v1beta2.custom.metrics.k8s.io
spec:
  group: custom.metrics.k8s.io
  groupPriorityMinimum: 100
  insecureSkipTLSVerify: true
  service:
    name: prometheus-adapter
    namespace: monitoring
  version: v1beta2
  versionPriority: 100
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adapter-config
  namespace: monitoring
data:
  config.yaml: |-
    "rules":
    - seriesQuery: 'http_requests_total' # Prometheus指标名称
      resources: # Prometheus 的 label 映射到 Kubernetes 的资源
        template: <<.Resource>>
      name:
        matches: "^http_requests_total$" # 只对 http_requests_total 这个 metric 名字进行匹配
        as: "http_requests_qps" # HPA指标名称
      metricsQuery: sum(rate(<<.Series>>{<<.LabelMatchers>>}[1m])) by (<<.GroupBy>>) # 真正查询 Prometheus 指标数据